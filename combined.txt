### File: ./default.conf

# Redirect HTTP traffic to HTTPS for both the main domain and the API subdomain
server {
    listen 80;
    server_name test-server-0.click api.test-server-0.click;
    location /.well-known/acme-challenge/ {
        root /usr/share/nginx/html;
        try_files $uri =404;
    }
    location / {
        return 301 https://$host$request_uri;
    }
}

# Configuration for the main domain
server {
    listen 443 ssl;
    server_name test-server-0.click;

    ssl_certificate /etc/letsencrypt/live/test-server-0.click/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/test-server-0.click/privkey.pem;

    # Redirect API requests to the API subdomain
    location ~ ^/api/ {
        rewrite ^/api/(.*)$ https://api.test-server-0.click/$1 permanent;
    }

    location / {
        root /usr/share/nginx/html;
        index index.html index.html;
        try_files $uri $uri/ /index.html;
    }
}

# Configuration for the API subdomain
server {
    listen 443 ssl;
    server_name api.test-server-0.click;

    ssl_certificate /etc/letsencrypt/live/test-server-0.click/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/test-server-0.click/privkey.pem;

    # SSL parameters directly included
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 5m;
    ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_stapling on;
    ssl_stapling_verify on;

    # Handle API requests
    location / {
        proxy_pass http://backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-CSRFTOKEN $http_x_csrftoken;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_redirect off;
        proxy_cookie_path / "/; HTTPOnly; Secure";
    }
}


### File: ./docker-compose.dev.yml

services:
  db:
    image: postgres:latest
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: myprojectdb
      POSTGRES_USER: derek
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: bash -c "python manage.py makemigrations && python manage.py migrate && gunicorn wsgi:application --bind 0.0.0.0:8000"
    ports:
      - "8000:8000"
    env_file:
      - .env
    depends_on:
      - db

  frontend:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./default.conf:/etc/nginx/conf.d/default.conf:ro  #  Nginx configuration file location
      - /etc/letsencrypt:/etc/letsencrypt:ro  # Path for accessing Let's Encrypt SSL Certs for HTTPS
      - /etc/nginx/ssl:/etc/nginx/ssl:ro  # Path to Diffie-Hellman Key Exchange Enc.
      - ./frontend/dist:/usr/share/nginx/html  # Frontend file location to serve with NGINX
    depends_on:
      - backend

volumes:
  postgres_data:

### File: ./docker-compose.yml

version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: gunicorn wsgi:application --bind 0.0.0.0:8000
    ports:
      - "8000:8000"
    env_file:
      - .env

### File: ./backend/__init__.py



### File: ./backend/apps.py

from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "core"


### File: ./backend/asgi.py

"""
ASGI config for backend project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.0/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "settings")

application = get_asgi_application()


### File: ./backend/manage.py

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == "__main__":
    main()


### File: ./backend/views.py

# encrypted-file-transfer/backend/views.py

from django.shortcuts import render
from django.http import HttpResponse
from django.conf import settings
import os
from django.views.decorators.csrf import csrf_exempt
from django.http import JsonResponse

@csrf_exempt
def index(request):
  try:
    with open(os.path.join(settings.REACT_APP_DIR, 'index.html')) as f:
      return HttpResponse(f.read())
  except FileNotFoundError:
    return HttpResponse(
      """
      This URL is only accessible after you've built the React frontend.
      """,
      status=501,
    )


### File: ./backend/wsgi.py

print("WSGI file loaded")
"""
WSGI config for project.

It exposes the WSGI callable as a module-level variable named ``application``.
"""

import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'settings')

application = get_wsgi_application()

### File: ./backend/settings.py

# encrypted-file-transfer/backend/settings.py
"""
Django settings for backend project.

Generated by 'django-admin startproject' using Django 5.0.2.

For more information on this file, see
https://docs.djangoproject.com/en/5.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.0/ref/settings/
"""

from pathlib import Path
from datetime import timedelta
import os
import logging

# Assuming all backend Django files are in /app
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY', 'django-insecure-d(7j9=&*)w%-m4bj!u9x3f68!zp58)px16+du#6a(r^!3(#h_e')
# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True
CORS_ALLOW_CREDENTIALS = True

ALLOWED_HOSTS = [os.environ.get('ALLOWED_HOSTS', 'localhost'), '0.0.0.0', 'test-server-0.click', 'api.test-server-0.click',]

CSRF_TRUSTED_ORIGINS = [
    # environment variable for the frontend URL
    os.environ.get('FRONTEND_URL', f'http://localhost:{os.environ.get("FRONTEND_PORT", "3000")}'),
    'https://test-server-0.click', 'http://test-server-0.click', 'http://localhost:80', 'https://localhost:80',
    'https://localhost:3000', 
]

CORS_ORIGIN_WHITELIST = [
    'https://localhost:3000',
    'http://localhost:3000',
    'https://localhost:80',
    'http://localhost:80',
    'https://test-server-0.click',
    'http://test-server-0.click',
]

# What's the difference between CSRF_TRUSTED_ORIGINS and CORS_ALLOWED_ORIGINS?
# CSRF_TRUSTED_ORIGINS is used to specify which origins are allowed to send
# cross-site requests. This is important for security reasons, as it helps
# prevent cross-site request forgery (CSRF) attacks. If you're using Django's
# CSRF protection middleware, you'll need to specify the origins that are
# allowed to send requests to your site. This is done by setting the
# CSRF_TRUSTED_ORIGINS setting in your Django settings file.
#
# CORS_ALLOWED_ORIGINS, on the other hand, is used to specify which origins
# are allowed to make cross-origin requests to your site. This is important
# for allowing requests from different domains, such as when you're building
# a frontend application that needs to make requests to a backend API. If you're
# using Django's CORS middleware, you'll need to specify the origins that are
# allowed to make requests to your site. This is done by setting the
# CORS_ALLOWED_ORIGINS setting in your Django settings file.
CORS_ALLOWED_ORIGINS = [
    os.environ.get('FRONTEND_URL', f'http://localhost:{os.environ.get("FRONTEND_PORT", "3000")}'),
    'http://test-server-0.click', 'https://test-server-0.click', 'https://test-server-0.click:80'
]

SESSION_COOKIE_AGE = 60

CSRF_COOKIE_HTTPONLY = True

SESSION_COOKIE_SECURE = True
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Lax'

CSRF_COOKIE_SECURE = True
CSRF_COOKIE_SAMESITE = 'Lax'
SESSION_COOKIE_SAMESITE = 'None'


# Application definition

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "core",
    "corsheaders",
    'debug_toolbar',
    'rest_framework',
    'knox',
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
    "debug_toolbar.middleware.DebugToolbarMiddleware",
    "core.middleware.RequestLoggingMiddleware",
]

DEBUG_TOOLBAR_PANELS = [
    'debug_toolbar.panels.headers.HeadersPanel',
    'debug_toolbar.panels.request.RequestPanel',
]

SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'knox.auth.TokenAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticated',
    )
}

ROOT_URLCONF = "urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]

WSGI_APPLICATION = "wsgi.application"


# Database
# https://docs.djangoproject.com/en/5.0/ref/settings/#databases

# Test Db:
# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.postgresql',
#         'NAME': 'myprojectdb',
#         'USER': 'derek',
#         'PASSWORD': 'postgres',
#         'HOST': 'db',
#         'PORT': '5432',
#     }
# }

# Production DB:
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.postgresql",
        "NAME": os.environ.get('DB_NAME', 'myprojectdb'),  # Default value is 'myproject-db'
        "USER": os.environ.get('DB_USER', 'derek'),  # Default value is 'postgres'
        "PASSWORD": os.environ.get('DB_PASSWORD', 'postgres'), 
        "HOST": os.environ.get('DB_HOST', 'localhost'),
        "PORT": os.environ.get('DB_PORT', '5432'),  # Default value is '5432'
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        "NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.MinimumLengthValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.CommonPasswordValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.NumericPasswordValidator",
    },
]

INTERNAL_IPS = [
    '127.0.0.1',
]

# Internationalization
# https://docs.djangoproject.com/en/5.0/topics/i18n/

LANGUAGE_CODE = "en-us"

TIME_ZONE = "UTC"

USE_I18N = True

USE_TZ = True

# Static URL is only used for development and not for
# production, ie serving our React app using Nginx.
STATIC_URL = '/static/'

# Directory where Django will store collected static files
# Adjust if necessary to match your desired path for static files

# REACT_APP_DIR isn't needed since we're serving our React app using Nginx.
# REACT_APP_DIR is a variable that points to the build directory
# of our React app. It's used in cases whenever you'd want your
# backend to serve the frontend as well. In this case, we're
# offloading this responsibility to Nginx, and using Django
# solely for backend functionality.
# REACT_APP_DIR = os.path.join(BASE_DIR, 'frontend/build')

# Directory where Django will store collected static files.
# This application doesn't store static files, as they are
# passed from the front end to the backend as blobs. A blob is
# essentially binary data that is only temporarily stored in memory
# for encrypting and decrypting, and is not stored on the server.
# It was only added here because Django gets angry if it's not there.
STATIC_ROOT = os.path.join(BASE_DIR, 'static')
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# Default primary key field type
DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"


# Logging added for spotting AWS RDS connection issues and other
# potential problems during the deployment process.
LOGGING = {
    'version': 1,
    'handlers': {
        'console': { 
            'level': 'DEBUG',
            'class': 'logging.StreamHandler', 
        },
    },
    'loggers': {
        'django': { 
            'handlers': ['console'], 
            'level': 'DEBUG',
            'propagate': True, 
        },
    },
}

### File: ./backend/urls.py

# encrypted-file-transfer/backend/urls.py

from django.urls import path, include
from views import index  # Adjusted import depending on your project structure

urlpatterns = [
    path('api/', include('core.urls')),
]


### File: ./backend/core/__init__.py



### File: ./backend/core/admin.py

from django.contrib import admin

# Register your models here.


### File: ./backend/core/apps.py

from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "core"


### File: ./backend/core/tests.py

from django.test import TestCase

# Create your tests here.


### File: ./backend/core/crypto_utils.py

# encrypted-file-transfer/backend/core/crypto_utils.py

from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.primitives import padding as sym_padding
from cryptography.hazmat.backends import default_backend
import os

def generate_key_iv():
    """
    Generates a new AES-256 key and IV.
    """
    key = os.urandom(32)  # AES-256 key
    iv = os.urandom(16)  # AES block size is 128 bits
    return key, iv

def encrypt_aes(data, key, iv):
    """
    Encrypts data using AES-256-CBC.
    """
    padder = sym_padding.PKCS7(128).padder()
    padded_data = padder.update(data) + padder.finalize()
    cipher = Cipher(algorithms.AES(key), modes.CBC(iv), backend=default_backend())
    encryptor = cipher.encryptor()
    return encryptor.update(padded_data) + encryptor.finalize()

def decrypt_aes(data, key, iv):
    """
    Decrypts data using AES-256-CBC.
    """
    cipher = Cipher(algorithms.AES(key), modes.CBC(iv), backend=default_backend())
    decryptor = cipher.decryptor()
    decrypted_data = decryptor.update(data) + decryptor.finalize()
    unpadder = sym_padding.PKCS7(128).unpadder()
    return unpadder.update(decrypted_data) + unpadder.finalize()

### File: ./backend/core/models.py

# encrypted-file-transfer/backend/core/models.py

from django.db import models
import uuid

class EncryptedFile(models.Model):
    id = models.AutoField(primary_key=True)
    uuid = models.UUIDField(default=uuid.uuid4, editable=False)
    key = models.BinaryField()
    iv = models.BinaryField()

### File: ./backend/core/urls.py

# encrypted-file-transfer/backend/core/urls.py

from django.urls import path
from . import views

urlpatterns = [
    # path('test/', views.test_endpoint, name='test_endpoint'),
    # path('generate_username/', views.generate_username, name='generate_username'),
    # path('register/', views.register, name='register'),
    # path('login/', views.login_view, name='login_view'),
    # path('logout/', views.logout_view, name='logout_view'),
    path('file_process/', views.file_process, name='file_process'),
    path('test_s3/', views.test_s3_connection, name='test_s3_connection'),
    path('test_headers/', views.test_headers, name='test_headers'),
    path('test_csrf_and_headers/', views.test_csrf_and_headers, name='test_csrf_and_headers'),
    ]

### File: ./backend/core/views.py

# backend/core/views.py

import boto3
from django.http import JsonResponse, HttpResponse
from django.contrib.auth.models import User
from django.contrib.auth import authenticate, login, logout
from django.views.decorators.csrf import csrf_exempt, ensure_csrf_cookie
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework import status
from django.contrib.auth.decorators import login_required
from rest_framework.permissions import AllowAny, IsAuthenticated

from .crypto_utils import encrypt_aes, decrypt_aes, generate_key_iv
from .models import EncryptedFile
import uuid
import base64
import logging

logger = logging.getLogger(__name__)

# @csrf_exempt
# @api_view(['GET'])
# def test_endpoint(request):
#     return JsonResponse({"message": "Test endpoint working!"})

# @csrf_exempt
# @api_view(['GET'])
# def generate_username(request):
#     logger.info("Frontend has requested the generated username.")
#     return JsonResponse({'username': 'Derek Gary'})

# @api_view(['POST'])
# @permission_classes([AllowAny])
# def register(request):
#     username = request.data.get('username')
#     password = request.data.get('password')
#     email = request.data.get('email')
    
#     if User.objects.filter(username=username).exists():
#         return Response({"error": "Username already taken"}, status=status.HTTP_409_CONFLICT)
#     if User.objects.filter(email=email).exists():
#         return Response({"error": "Email already in use"}, status=status.HTTP_409_CONFLICT)

#     user = User.objects.create_user(username=username, email=email, password=password)
#     login(request, user)  # Log the user in, Django handles cookie setting
#     return JsonResponse({"detail": "User registered successfully"})

# @api_view(['POST'])
# def logout_view(request):
#     logout(request)  # Django clears the session
#     response = JsonResponse({"detail": "Logged out"})
#     response.delete_cookie('sessionid')  # Ensure to delete the sessionid cookie
#     return response

# @api_view(['POST'])
# @permission_classes([AllowAny])
# def login_view(request):
#     username = request.data.get('username')
#     password = request.data.get('password')
#     user = authenticate(request, username=username, password=password)
#     if user is not None:
#         login(request, user)  # Log the user in, Django handles cookie setting
#         return JsonResponse({'detail': 'Login successful'})
#     else:
#         return JsonResponse({'error': 'Invalid username or password'}, status=401)



@api_view(['POST'])
@ensure_csrf_cookie
@permission_classes([AllowAny])
def file_process(request):
    if request.method == 'POST' and request.FILES:
        file = request.FILES['file']
        file_name = f"{uuid.uuid4()}-{request.FILES['file'].name}"
        s3_client = boto3.client('s3', region_name='us-east-2')
        bucket = 'secure-file-bucket'
        
        try:
            # Upload File to S3 Bucket
            s3_client.upload_fileobj(
                file,
                bucket,
                file_name,
            )
            
            presigned_url = s3_client.generate_presigned_url(
                'get_object',
                Params={'Bucket': bucket, 'Key': file_name},
                ExpiresIn=86400  # Time in seconds (24 hours)
            )

            return JsonResponse({'message': 'File uploaded successfully.', 'url': presigned_url})
        except Exception as e:
            return JsonResponse({'error': str(e)}, status=500)
    else:
        return JsonResponse({'error': 'No file found'}, status=400)




@api_view(['GET'])
@ensure_csrf_cookie
@permission_classes([AllowAny])
def test_s3_connection(request):
    """
    Test connectivity to AWS S3 by listing the buckets available.
    """
    s3_client = boto3.client('s3')
    try:
        # Attempt to list buckets
        response = s3_client.list_buckets()
        
        # Extract bucket names to demonstrate connectivity
        buckets = [bucket['Name'] for bucket in response['Buckets']]
        return JsonResponse({'message': 'Successfully connected to S3.', 'buckets': buckets})
        
        # Log Error Messagge to Docker Logs in case of failure.
    except Exception as e:
        logger.error(f"\n\n\n == S3 BUCKET ERROR == \n\n\nFailed to connect to S3: {str(e)}\n\n\n")
        return JsonResponse({'error': f"Failed to connect to S3: {str(e)}"}, status=500)



@api_view(['GET'])
@permission_classes([AllowAny])
def test_headers(request):
    """
    Return the headers received from the request.
    """
    headers = dict(request.headers)
    return JsonResponse({'received_headers': headers})
    
    
    
@api_view(['POST'])
@ensure_csrf_cookie
@permission_classes([AllowAny])
def test_csrf_and_headers(request):
    """
    Return the headers received and compare them to expected CSRF tokens.
    """
    received_headers = dict(request.headers)
    expected_token = request.META.get('CSRF_COOKIE', 'No CSRF cookie found')
    return JsonResponse({
        'received_headers': received_headers,
        'expected_csrf_token': expected_token
    })


### File: ./backend/core/middleware.py

import logging
logger = logging.getLogger(__name__)

class RequestLoggingMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        response = self.get_response(request)
        logger.debug(f"Request Headers: {request.headers}")
        logger.debug(f"Request Cookies: {request.COOKIES}")
        logger.debug(f"Request Path: {request.path}")
        return response

### File: ./backend/core/.~c9_invoke_GU1igA.py

# backend/core/views.py

from django.http import JsonResponse, HttpResponse
import boto3
from django.contrib.auth.models import User
from django.contrib.auth import authenticate, login, logout
from django.views.decorators.csrf import csrf_exempt, ensure_csrf_cookie
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework import status
from django.contrib.auth.decorators import login_required
from rest_framework.permissions import AllowAny, IsAuthenticated

from .crypto_utils import encrypt_aes, decrypt_aes, generate_key_iv
from .models import EncryptedFile
import uuid
import base64
import logging

logger = logging.getLogger(__name__)

# @csrf_exempt
# @api_view(['GET'])
# def test_endpoint(request):
#     return JsonResponse({"message": "Test endpoint working!"})

# @csrf_exempt
# @api_view(['GET'])
# def generate_username(request):
#     logger.info("Frontend has requested the generated username.")
#     return JsonResponse({'username': 'Derek Gary'})

# @api_view(['POST'])
# @permission_classes([AllowAny])
# def register(request):
#     username = request.data.get('username')
#     password = request.data.get('password')
#     email = request.data.get('email')
    
#     if User.objects.filter(username=username).exists():
#         return Response({"error": "Username already taken"}, status=status.HTTP_409_CONFLICT)
#     if User.objects.filter(email=email).exists():
#         return Response({"error": "Email already in use"}, status=status.HTTP_409_CONFLICT)

#     user = User.objects.create_user(username=username, email=email, password=password)
#     login(request, user)  # Log the user in, Django handles cookie setting
#     return JsonResponse({"detail": "User registered successfully"})

# @api_view(['POST'])
# def logout_view(request):
#     logout(request)  # Django clears the session
#     response = JsonResponse({"detail": "Logged out"})
#     response.delete_cookie('sessionid')  # Ensure to delete the sessionid cookie
#     return response

# @api_view(['POST'])
# @permission_classes([AllowAny])
# def login_view(request):
#     username = request.data.get('username')
#     password = request.data.get('password')
#     user = authenticate(request, username=username, password=password)
#     if user is not None:
#         login(request, user)  # Log the user in, Django handles cookie setting
#         return JsonResponse({'detail': 'Login successful'})
#     else:
#         return JsonResponse({'error': 'Invalid username or password'}, status=401)



@api_view(['POST'])
def file_process(request):
    if request.method == 'POST' and request.FILES:
        file = request.FILES['file']
        action = request.POST.get('action', '')
        logger.info(f"Received file for action {action}.")
        return JsonResponse({'message': 'File processed successfully'})
    return JsonResponse({'error': 'Invalid request'}, status=400)




@csrf_exempt
@api_view(['GET'])
def test_s3_connection(request):
    """
    Test connectivity to AWS S3 by listing the buckets available.
    """
    s3_client = boto3.client('s3')
    try:
        # Attempt to list buckets
        response = s3_client.list_buckets()
        
        # Extract bucket names to demonstrate connectivity
        buckets = [bucket['Name'] for bucket in response['Buckets']]
        return JsonResponse({'message': 'Successfully connected to S3.', 'buckets': buckets})
        
        # Log Error Messagge to Docker Logs in case of failure.
    except Exception as e:
        logger.error(f"\n\n\n == S3 BUCKET ERROR == \n\n\nFailed to connect to S3: {str(e)}\n\n\n")
        return JsonResponse({'error': f"Failed to connect to S3: {str(e)}"}, status=500)



@api_view(['GET'])
@permission_classes([AllowAny])
def test_headers(request):
    """
    Return the headers received from the request.
    """
    headers = dict(request.headers)
    return JsonResponse({'received_headers': headers})
    
    
    
@api_view(['POST'])
@ensure_csrf_cookie
@permission_classes([AllowAny])
def test_csrf_and_headers(request):
    """
    Return the headers received and compare them to expected CSRF tokens.
    """
    received_headers = dict(request.headers)
    expected_token = request.META.get('CSRF_COOKIE', 'No CSRF cookie found')
    return JsonResponse({
        'received_headers': received_headers,
        'expected_csrf_token': expected_token
    })


### File: ./backend/core/migrations/__init__.py



### File: ./backend/core/migrations/0001_initial.py

# Generated by Django 5.0.3 on 2024-03-10 03:53

import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='EncryptedFile',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('uuid', models.UUIDField(default=uuid.uuid4, editable=False)),
                ('key', models.BinaryField()),
                ('iv', models.BinaryField()),
            ],
        ),
    ]


### File: ./frontend/.eslintrc.cjs

module.exports = {
  root: true,
  env: { browser: true, es2020: true },
  extends: [
    'eslint:recommended',
    'plugin:react/recommended',
    'plugin:react/jsx-runtime',
    'plugin:react-hooks/recommended',
  ],
  ignorePatterns: ['dist', '.eslintrc.cjs'],
  parserOptions: { ecmaVersion: 'latest', sourceType: 'module' },
  settings: { react: { version: '18.2' } },
  plugins: ['react-refresh'],
  rules: {
    'react/jsx-no-target-blank': 'off',
    'react-refresh/only-export-components': [
      'warn',
      { allowConstantExport: true },
    ],
  },
}


### File: ./frontend/index.html

<!-- frontend/index.htm -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="/vite.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="/logo192.png">
    <link rel="manifest" href="/manifest.json">
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Encrypted File Transfer</title>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <!-- Bootstrap Bundle with Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script type="module" src="/src/main.jsx"></script>
</body>
</html>


### File: ./frontend/vite.config.js

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  server: {
    port: 3000
  },
  plugins: [
    react()
  ],
  resolve: {
    alias: {
      // Add aliases
      '@': path.resolve(__dirname, './src'),
      // Ensure redux toolkit is correctly recognized
      '@reduxjs/toolkit': path.resolve(__dirname, 'node_modules/@reduxjs/toolkit')
    }
  },
  build: {
    rollupOptions: {
      external: [], // Define external packages if necessary
      output: {
        // Adjust chunking behavior
        manualChunks(id) {
          if (id.includes('node_modules')) {
            return id.toString().split('node_modules/')[1].split('/')[0].toString();
          }
        }
      }
    }
  },
  optimizeDeps: {
    include: ['@reduxjs/toolkit'],
  }
});


### File: ./frontend/src/index.css

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}

.UUID-label {
  font-size: 0.5em;
  margin: 10px;
}

.inline-container {
  display: flex;
  align-items: center;
  margin: 0px;
  padding: 0px;
}

input[type="file"] {
  flex-grow: 0;
}

.inline-container > div {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#uuidInput {
  width: 100%;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
  text-align: center;
}

### File: ./frontend/src/App.jsx

// frontend/src/App.jsx

import React from 'react';
import { BrowserRouter as Router, Route, Routes } from 'react-router-dom';
import LandingPage from './pages/LandingPage';
import NotFoundPage from './pages/NotFoundPage';
import './styles/App.css'; // Global Styles

// This serves as the router for our different pages.
function App() {
  return (
      <Routes>
        <Route path="/" element={<LandingPage />} />
        <Route path="*" element={<NotFoundPage />} />
      </Routes>
  );
}

export default App;


### File: ./frontend/src/main.jsx

// src/main.jsx
import React, { useEffect, useState } from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import App from './App';
import './index.css';
import { Provider } from 'react-redux';
import { initializeStore } from './store';  // This should now work correctly
import { UserProvider } from './contexts/UserContext';
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <BrowserRouter>
    <UserProvider>
      <App />
    </UserProvider>
  </BrowserRouter>
);


### File: ./frontend/src/store.js

// src/store.js
import { configureStore } from '@reduxjs/toolkit';
import { thunk } from 'redux-thunk';
import rootReducer from './reducers';

const store = configureStore({
    reducer: rootReducer,
    middleware: (getDefaultMiddleware) => getDefaultMiddleware().concat(thunk),
});

export default store;


### File: ./frontend/src/styles/App.css

/* App.css */
.App {
  text-align: center;
  background-color: #282c34;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  font-size: calc(10px + 2vmin);
  color: white;
  padding-top: 50px;
}

.App-header {
  background-color: #404040;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
  margin: 20px 0;
  width: 80%;
  max-width: 600px;
}

input[type="file"] {
  margin: 10px 0;
}

.uuid-box {
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 10px;
  margin: 15px;
}

.radio-btn {
  font-size: 0.44em;
}

button {
  background-color: #1d9e33;
  border: none;
  border-radius: 5px;
  padding: 10px 20px;
  color: #fff;
  cursor: pointer;
  transition: background-color 0.3s;
}

button:hover {
  background-color: #51df68;
}

.submit-button-container {
  display: flex;
  justify-content: center;
  margin-top: 10px;
}

.uuid-input-container {
  text-align: center;
  margin-top: 20px;
}

.tips-title {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.tips-section {
  background-color: #404040;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
  margin: 20px 0;
  width: 80%;
  max-width: 600px;
  color: #ccc;
  text-align: left;
  font-size: 0.5em;
}

.tips-section ol {
  counter-reset: list-counter;
  list-style-type: none;
  padding-left: 20px;
}

.tips-section ol li {
  counter-increment: list-counter;
  margin-bottom: 10px;
}

.tips-section ol li::before {
  content: counter(list-counter) ". ";
  font-weight: bold;
  margin-right: 5px;
}

.tips-section p {
  margin-bottom: 20px;
  font-weight: bold;
}


### File: ./frontend/src/styles/LandingPage.css

.dark-mode {
    background-color: #343a40;
    color: #f8f9fa;
}

.dark-mode .navbar-light .navbar-nav .nav-link {
    color: #f8f9fa !important; /* Ensure nav links are visible in dark mode */
}

.btn-dark-mode-toggle {
    background-color: #343a40;
    color: #f8f9fa;
    border-color: #f8f9fa; /* Ensure the button is visible against the navbar */
}

.navbar-light .btn-dark-mode-toggle {
    background-color: #343a40;
    color: #f8f9fa;
}

/* Ensures navbar stays light in dark mode */
.dark-mode .navbar-light {
    background-color: #f8f9fa;
    color: #343a40;
}


### File: ./frontend/src/components/Layout.jsx

import React from 'react';
import { Link } from 'react-router-dom';

function Layout({ children }) {
    return (
        <div>
            <nav className="navbar navbar-expand-lg navbar-light bg-light">
                <div className="container">
                    <Link className="navbar-brand" to="/">Home</Link>
                    <div className="collapse navbar-collapse">
                        <ul className="navbar-nav me-auto mb-2 mb-lg-0">
                        </ul>
                    </div>
                </div>
            </nav>
            {children}
        </div>
    );
}

export default Layout;


### File: ./frontend/src/pages/LandingPage.jsx

import React, { useEffect } from 'react';
import Layout from '../components/Layout';
import Cookies from 'js-cookie';

function LandingPage() {
  // This function handles the file upload and stores the presigned URL
  const handleUpload = async (event) => {
    
    event.preventDefault();
    const formData = new FormData(event.currentTarget);
    formData.append('file', event.currentTarget.file.files[0]);

    try {
      const response = await fetch('https://api.test-server-0.click/api/file_process/', {
        
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': Cookies.get('csrftoken'), // Always pass the CSRF token, Derek! (-_-")
        },
      });
      
      const data = await response.json();
      
      if (data.url) {
        alert(`File uploaded! Download link: ${data.url}`);
        
        // Save the URL in local storage
        localStorage.setItem('fileDownloadLink', JSON.stringify({ url: data.url, timestamp: new Date().getTime() }));
      } else {
        alert('Failed to upload file.');
      }
    } catch (error) {
      console.error('Upload error:', error);
      alert('An error occurred while uploading the file.');
    }
  };


  useEffect(() => {
    async function checkS3Connection() {
      const csrfToken = Cookies.get('csrfToken');
      try {
        const response = await fetch('https://api.test-server-0.click/api/test_s3/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
        });
        const data = await response.json();
        console.log('S3 Connection Test:', data);
      } catch (error) {
        console.error('Error testing S3 connection:', error);
      }
    }
    checkS3Connection();
  }, []);

  // Check and display the URL on page load if it's still valid
  useEffect(() => {
    const fileLinkData = JSON.parse(localStorage.getItem('fileDownloadLink'));
    if (fileLinkData && new Date().getTime() - fileLinkData.timestamp < 86400000) { // 24 hours check
      alert(`Your download link is still available: ${fileLinkData.url}`);
    }
  }, []);

  return (
    <Layout>
      <div className="container mt-12">
        <div className="row">
          <div className="col-md-1">
            {/* Left column content */}
          </div>
          <div className="col-md-10 justify-content-center" style={{ minHeight: 'calc(100vh - 56px)' }}>
            <div className="text-center mt-5 bg-secondary ps-5 pe-5 pb-5 pt-3 rounded shadow">
              <h1>Welcome to Secure File Transfer</h1>
              <p>This application allows you to securely send files to other users. Upload a file to create a secure QR code.</p>
              <form onSubmit={handleUpload} className="mt-4">
                <input type="file" name="file" required />
                <button type="submit" className="btn btn-success">Upload File</button>
              </form>
            </div>
          </div>
          <div className="col-md-1">
            {/* Right column content */}
          </div>
        </div>
      </div>
    </Layout>
  );
}

export default LandingPage;

### File: ./frontend/src/pages/NotFoundPage.jsx

import React from 'react';
import Layout from '../components/Layout';

function NotFoundPage() {
  return (
    <Layout>
      <div className="container">
        <div className="row justify-content-center">
          <div className="col-12 text-center">
            <h1>404 Not Found</h1>
            <p>The page you are looking for does not exist.</p>
          </div>
        </div>
      </div>
    </Layout>
  );
}

export default NotFoundPage;


